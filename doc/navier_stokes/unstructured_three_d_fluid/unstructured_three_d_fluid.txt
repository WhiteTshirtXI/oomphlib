\mainpage Demo problem: Fluid Mechanics on unstructured 3D meshes

This tutorial provides another demonstration of how to use
3D unstructured meshes for the solution of fluid flow problems.
(The <a href="../../../meshes/mesh_from_tetgen/html/index.html">
tetgen tutorial</a> already contains a 3D unstructured fluid example.)

The specific problem considered here serves as a "warm-up problem" for the
<a href="../../../interaction/unstructured_three_d_fsi/html/index.html">
corresponding fluid-structure interaction problem</a> in which the
domain boundary is replaced by an elastic vessel.


<HR>
<HR>

\section problem The problem 
Here is a sketch of the problem: Flow is driven through a 3D rigid vessel
made of three approximately rectangular tubes that meet at a 
common junction. The flow is driven by a prescribed pressure
drop between the upstream and the two downstream ends, \f$ \Delta p^* = 
P^*_{in} - P^*_{out}, \f$ and we assume/impose parallel in and outflow
in the inlet and outlet cross-sections which are parallel to 
\f$ x-y \f$ coordinate plane. 

@I w 0.75\textwidth problem_sketch "Sketch of the problem. "
 

<HR>
<HR> 


\section mesh 3D unstructured mesh generation
We generate the unstructured tetrahedral mesh using the output from 
<A HREF="http://www.wias-berlin.de/~si ">Hang Si's</A>
open-source mesh generator 
<A HREF="http://tetgen.berlios.de/"> \c tetgen </A>.
The mesh generation is thus performed in a two-stage process.
First we use <A HREF="http://tetgen.berlios.de/">
\c tetgen </A> to generate the mesh "offline". Then we
process the output files generated by  
<A HREF="http://tetgen.berlios.de/"> \c tetgen </A>
to generate an unstructured \c oomph-lib mesh. 

<A HREF="http://tetgen.berlios.de/"> \c Tetgen </A>
requires the specification of the domain boundaries
via so-called facets -- planar surface patches that are bounded
by closed polygonal line segments. In our simple geometry
each of the three tube segments has four external
faces. Together with the three in- and outflow sections
this results in a total of 15 facets.


The 15 facets are defined in a <code>*.poly</code> file that
specifies the position of the vertices, and identifies the 
facets via a "face list" that establishes their bounding vertices. 
The well-annotated <code>*.poly</code> file is located at:

<center>
<a href="../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.poly">demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.poly</a>
</center>

We refer to the <A HREF="http://tetgen.berlios.de/"> \c tetgen webpages </A>
and another <a href="../../../meshes/mesh_from_tetgen/html/index.html">
\c oomph-lib tutorial</a> for further details on how to 
create <code>*.poly</code> files.


Here is a plot of the domain specified by <a
href="../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.poly">fsi_bifurcation_fluid.poly</a>.
The plot was created using \c tetview which is distributed with
<A HREF="http://tetgen.berlios.de/"> \c tetgen </A>.

@I w 0.75\textwidth tetgen_boundaries  "The domain and its bounding facets. "

<A HREF="http://tetgen.berlios.de/"> \c Tetgen </A> generates
an unstructured volumetric mesh from the information contained
in the <code>*.poly</code> file and outputs the mesh's nodes, 
elements and faces in the files
- <a href="../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.1.node">demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.1.node</a>
- <a href="../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.1.ele">demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.1.ele</a>
- <a
href="../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.1.face">demo_drivers/navier_stokes/unstructured_three_d_fluid/fsi_bifurcation_fluid.1.face</a>
.
These files can be used as input to \c oomph-lib's \c TetgenMesh
class, using the procedure disussed in 
<a href="../../../meshes/mesh_from_tetgen/html/index.html">
another tutorial.</a>
   
  The figure below shows a \c tetview plot of the mesh, created with a volume
constraint of 0.2 (i.e. the maximum volume of each tetrahedron is
guaranteed to be less than 0.2 units), using the command
\code
tetgen -a0.2 fsi_bifurcation_fluid.poly 
\endcode
 
@I w 0.75\textwidth mesh_boundaries "Plot of the mesh, generated by tetgen. "
 
Note how <A HREF="http://tetgen.berlios.de/"> \c tetgen </A>
has subdivided each of the 27 original facets specified in the 
<code>*.poly</code> file into a surface triangulation. The 
nodes and tetrahedral elements that are located on (or adjacent to) the
27 original facets inherit their boundary IDs.

<HR>
<HR>

\section mesh_code Creating the mesh

We create the solid mesh by multiple inheritance from \c oomph-lib's 
\c TetgenMesh and the \c SolidMesh base class:

\dontinclude unstructured_three_d_solid.cc
\skipline start_mesh
\until {

The constructor calls the constructor of the underlying 
\c TetgenMesh (using the <code>*.node </code>
<code>*.ele</code> and <code>*.face</code> files created
by <A HREF="http://tetgen.berlios.de/"> \c tetgen. </A>
As usual we set the nodes' Lagrangian coordinates to their current 
Eulerian positions, making the current configuration
stress-free.

\until set_lagrangian_nodal_coordinates()

Finally, we identify the elements that are located next to the 
various mesh boundaries.

\until };

<HR>
<HR>













\section mesh Mesh generation
We employ the combination of <A HREF="http://www.xfig.org/">xfig</A>,
\c oomph-lib's conversion code 
<a href="../../../meshes/mesh_from_xfig/html/index.html">
\c fig2poly </a>, and the unstructured
mesh generator 
<A HREF="http://www.cs.cmu.edu/~quake/triangle.html">\c Triangle
</A> to generate the mesh, using the procedure discussed in 
<a href="../../../meshes/mesh_from_xfig/html/index.html">
another tutorial.</a>

We start by drawing the outline of the fluid domain as a polyline in
<A HREF="http://www.xfig.org/">xfig</A>:

@I w 0.75\textwidth xfig_screenshot  "xfig drawing of the fluid body. "
 
(Note that we draw the domain upside-down because of the way 
<A HREF="http://www.xfig.org/">xfig</A> orients its coordinate axes.)

We save the figure as a *.fig file and convert it to a *.poly file
using \c oomph-lib's conversion code 
<a href="../../../meshes/mesh_from_xfig/html/index.html">
\c fig2poly </a> (a copy of which is
located in \c oomph-lib's \c bin directory): 

\code
fig2poly fluid.fig 
\endcode

This creates a file called \c fluid.fig.poly that can be processed
with triangle. For instance, to create a quality mesh with a maximum
element size of 0.03 we use
\code
triangle -q -a0.03 fluid.fig.poly
\endcode

Here is a plot of the mesh, generated by \c showme 
which is distributed with 
<A HREF="http://www.cs.cmu.edu/~quake/triangle.html">\c Triangle
</A>:

@I w 0.75\textwidth showme_screenshot "Visualisation of the mesh with showme. "

The <CODE> *.poly, *.ele </CODE> and <CODE> *.node </CODE>
files generated by 
<A HREF="http://www.cs.cmu.edu/~quake/triangle.html">\c Triangle
</A> can now be used as input to \c oomph-lib's 
\c TriangleMesh class.
 
<HR>
<HR> 



\section results Results
The animation shown below illustrates the flow field (streamlines and
pressure contours) for Reynolds numbers of \f$ Re=0, 5, 10, ... \f$
An increase in Reynolds number increases the length
of the recirculation region behind the obstacle; furthermore,
the sharp corner at the "leading edge" of the obstacle creates
very low pressures just downstream of the corner. 

@I w 0.75\textwidth stream "Flowfield (streamlines and pressure contours) at various Reynolds numbers. "


<HR>
<HR>

\section mesh_code Creating the mesh

In anticipation of the mesh's use in a fluid-structure interaction
problem, we create the mesh by multiple inheritance from \c oomph-lib's 
\c TriangleMesh and the \c SolidMesh base class. This will allow
us to use pseudo-solid node-update techniques to update the position
of the fluid nodes in response to changes in the domain boundary. 
In the present problem, the "elasticity" of the fluid elements
plays no useful role; see \ref comm_ex for instructions on how to 
remove the pseudo-elasticity from the problem.

\dontinclude unstructured_three_d_fluid.cc
\skipline start_mesh
\until { 

The constructor calls the constructor of the underlying 
\c TriangleMesh, and, as usual, sets the Lagrangian coordinates
to the current nodal positions, making the current configuration
stress-free.

\until set_lagrangian_nodal_coordinates()

The \c TriangleMesh constructor associates each polyline in the
\c xfig drawing with a distinct \c oomph-lib mesh boundary. Hence
the boundary nodes are initially located on the same, single boundary. 
To facilitate the application of boundary conditions, we re-assign
some of the nodes to two additional boundaries, making a total
of three:

\until set_nboundary

We loop over all nodes in the mesh and identify nodes on the left
(inflow) boundary by their x-coordinate. We remove the node
from the boundary 0 and re-allocate it to the new boundary 1:

\until }

Similarly, we identify all nodes on the right (outflow) boundary and
re-assign them to boundary 2, before re-generating the various boundary
lookup schemes that identify which elements are located next
to the various mesh boundaries:

\until };

<HR>
<HR>

\section namespace Problem Parameters
As usual we define the various problem parameters in a 
global namespace. We define the Reynolds number and 
prepare a pointer to a constitutive equation (for the pseudo-elastic
elements).

\skipline start_namespace
\until end_of_namespace

<HR>
<HR>

\section main The driver code

We specify an output directory and instantiate a constitutive 
equation for the pseudo-elasticity, specifying a Poisson ratio of 0.3.

\dontinclude unstructured_three_d_fluid.cc
\skipline start_of_main
\until 0.3);

We create the \c Problem object and output the domain boundaries
and the initial guess for the flow field.

\until ()++

Finally, we perform a straightforward parameter study by
slowly increasing the Reynolds number of the flow from zero.

\until end_of_main


<HR>
<HR>

\section class The Problem class
The \c Problem class has the usual member functions and provides
explicit storage for the fluid mesh. (This is again slight overkill
for the problem at hand, and is done mainly in anticipation of 
the "upgrade" of this driver code to 
<a href="../../../interaction/unstructured_fsi/html/index.html">
the FSI problem</a> with its 
multiple meshes; in the present problem we could, of course, store the 
pointer to the problem's one-and-only mesh directly in 
\c Problem::mesh_pt() ). 

\dontinclude unstructured_three_d_fluid.cc
\skipline start_of_problem_class
\until };



<HR>
<HR>

\section constructor The Problem constructor

We start by building the fluid mesh, using the files created
by <A HREF="http://www.cs.cmu.edu/~quake/triangle.html">\c Triangle
</A>.

\skipline start_constructor
\until fluid_poly_file_name);
 
Next, we apply the boundary conditions for the fluid and the 
pseudo-solid equations. We pin the pseudo-solid nodes along
all domain boundaries, apply a no-slip condition for the fluid velocity 
along the solid boundary  (boundary 0), pin the velocity at the inflow
(boundary 1, where we will impose a Poiseuille flow profile), and impose
parallel outflow at the downstream end (boundary 2). 
Given that the manual identification of
mesh boundaries in unstructured meshes that are generated by
third-party mesh generators is a relatively error-prone process, we
document the boundary conditions in three separate files to allow 
an external sanity check; see
<a href="../../../solid/unstructured_solid/html/index.html#comm_ex">
the comments in the corresponding solid mechanics tutorial.</a>
The \ref comm_ex section of the present tutorial also has a sub-section 
that illustrates what can go wrong. 

\until solid_bc_file.close();

We add the fluid mesh as a single sub-mesh to the \c Problem and build
the global mesh (see the comment in \ref class .)

\until build_global

We complete the build of the elements by specifying
the Reynolds number and the constitutive equation for the pseudo-solid
equations. 

\until }

Finally, we impose a Poiseuille profile at the inflow boundary (boundary
1) and assign the equation numbers.

\until end_of_constructor


<HR>
<HR>

\section doc Post-processing

The post-processing routine outputs the flow field.

\until }


<HR>
<HR>

\section comm_ex Comments and Exercises



<HR> 
 
 
\subsection reynolds What is the Reynolds number?
 
The problem considered here is primarily a toy-problem, devised
to illustrate the use of unstructured meshes for fluids problems.
The specific non-dimensionalisation and parameter values are therefore
of secondary importance. However, since \c oomph-lib's implementation
of the Navier-Stokes equations is based on their non-dimensional form
it is important to clarify the meaning of the Reynolds number 
in the present problem. 

<a href="../../driven_cavity/html/index.html#equation">Recall</a> 
that the Reynolds number is defined as 
\f[
Re = \frac{\rho {\cal U} {\cal L}}{\mu}
\f]
where \f$ \rho \f$ and \f$ \mu \f$ are the fluid density and viscosity,
respectively.  \f$ {\cal L} \f$ is the reference length chosen for the
non-dimensionalisation of the coordinates. In the present problem,
where the domain boundaries were simply drawn in 
<A HREF="http://www.xfig.org/">xfig </a>, no specific reference
length was identified, but inspection of the maximum and minimum 
y-coordinates of the inflow boundary in the mesh plot 
shows that the inflow boundary has a (dimensional) length 
of \f$ (4.0875 - 0.1125) {\cal L} = 3.975 {\cal L}. \f$
In the non-dimensional version of the Navier-Stokes equations, all 
velocities are non-dimensionalised with a reference velocity
\f$ {\cal U} \f$. When we applied the inflow boundary conditions,
we chose the (dimensionless) inflow profile such that its 
integral over the inflow boundary yields a value of 1. The velocity 
scale \f$ {\cal U} \f$ may therefore be interpreted as 
the (dimensional) average inflow velocity through the channel, i.e. the
volume flux divided by the width of the channel at its inflow.

<HR>

\subsection bound Identification/assigment of mesh boundaries
We wish to re-iterate the comments made in the 
<a href="../../../solid/unstructured_solid/html/index.html#comm_ex">
corresponding solid mechanics tutorial</a> that the manual 
identification of nodes on domain boundaries is tedious and 
therefore error prone. It pays off to <B>be  as a paranoid 
as possible</B>, by always documenting the domain boundaries and the
applied boundary conditions. 

 Here is the plot of boundary conditions applied in the present
problem. Hollow blue markers indicate (pseudo-)solid boundary conditions
(both displacements are pinned); small red markers identify nodes
where the vertical fluid velocity is pinned; hollow green markers (filling
the space between the blue and red lines markers) identify nodes at
which the horizontal fluid velocity is pinned. 

@I w 0.75\textwidth bcs "Plot of the correct boundary conditions. "

Here is another plot, obtained with the initial version of 
our driver code -- can you spot what's wrong and can you
identify the lines we had to add to the mesh constructor to 
fix the problem? 

@I w 0.75\textwidth bcs_wrong "Plot of the wrong boundary conditions. "



<HR>

\subsection pseudo_elast Pseudo-elasticity

As mentioned above, the elements' pseudo-elasticity plays no useful
role in the present problem, as the domain boundaries remain
at fixed positions and no mesh movement is required. 

- As an exercise, remove all functionality related to the 
  pseudo-elasticity by changing the element type from
  \code
  PseudoSolidNodeUpdateElement<TTaylorHoodElement<2>,TPVDElement<2,3> >
  \endcode
  to
  \code
  TTaylorHoodElement<2>
  \endcode
  Adjust the code as required (e.g. remove mesh's inheritance from the
  \c SolidMesh base class; remove the application of boundary conditions
  for the nodal positions; etc) and confirm that the results
  for the flow field remain unchanged.
  \n\n
- Alternatively, the pseudo-elasticity can can be suppressed by 
  pinning all nodal positions, drastically reducing the number
  of degrees of freedom in the problem without the need to 
  rewrite the rest of the code. (Note that this is also a useful
  test for the development of FSI codes.)
  \n\n
- However, you may wish to retain the pseudo-elastic capabilities
  and convince yourself that the fluid mesh can indeed deform as an elastic
  body, by specifying a (solid mechanics) body force. To do this,
  simply follow the steps used in 
  <a href="../../../solid/unstructured_solid/html/index.html">
  the corresponding solid mechanics problem:</a> Define the body
  force in the namespace \c Global_Physical_Variables
  and pass a (function-)pointer to it 
  to the elements. (N.B. you will have to specify explicitly
  that you're assigning the body force for the (pseudo-)solid
  as the Navier-Stokes equations have their own body force
  pointer! The compiler will complain about ambiguities if you
  write
  \n
  \code
  [...]

   //Set the body force
   el_pt->body_force_fct_pt() = Global_Physical_Variables::gravity;

  [...]  
  \endcode
  You'll have to be more specific by writing
  \n
  \code
  [...]

   //Set the body force
   el_pt->PVDEquationsBase<2>::body_force_fct_pt() = 
    Global_Physical_Variables::gravity;
  
  [...]   
  \endcode
  instead, indicating that you wish to assign the body force defined in the
  2D solid mechanics equations.
.

<HR>
<HR>

\section sources Source files for this tutorial
- The source files for this tutorial are located in the directory:\n\n
<CENTER>
<A HREF="../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/">
demo_drivers/navier_stokes/unstructured_three_d_fluid/
</A>
</CENTER>\n
- The driver code is: \n\n
<CENTER>
<A HREF="../../../../demo_drivers/navier_stokes/unstructured_three_d_fluid/unstructured_three_d_fluid.cc">
demo_drivers/navier_stokes/unstructured_three_d_fluid/unstructured_three_d_fluid.cc
</A>
</CENTER>
.










